<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Orders — Superkicks</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ash: '#f8f8f8',
            graphite: '#e5e5e5'
          },
          animation: {
            'fade-in': 'fade-in 0.6s ease-out',
            'pulse-red': 'pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            'fade-in': {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            },
            'pulse-red': {
              '0%, 100%': { opacity: '1' },
              '50%': { opacity: '0.7' }
            }
          }
        }
      }
    }
  </script>
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    html, body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .focus-ring:focus { outline: 2px solid #000; outline-offset: 2px; }
    .failed-payment-border {
      background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);
      border: 2px solid #ef4444;
      position: relative;
    }
    .failed-payment-border::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ef4444, #dc2626, #ef4444);
      border-radius: inherit;
      z-index: -1;
      animation: pulse-red 2s ease-in-out infinite;
    }
    .retry-payment-btn {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
      transition: all 0.3s ease;
    }
    .retry-payment-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.6);
    }
  </style>
</head>

<body class="min-h-full bg-white text-black">
  <%- include('../partials/header') %>

  <div id="user-data-container" 
       style="display: none;" 
       data-user="<%- encodeURIComponent(JSON.stringify({
         id: user?.id || '',
         name: user?.name || 'Customer',
         email: user?.email || 'customer@example.com'
       })) %>">
  </div>

  <div id="loading-overlay" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 shadow-xl">
      <div class="flex items-center gap-3">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-black"></div>
        <span>Processing...</span>
      </div>
    </div>
  </div>

  <main class="mx-auto w-full max-w-7xl px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
    
    <div class="mb-6 sm:mb-8 animate-fade-in">
      <h1 class="text-xl md:text-3xl font-bold tracking-tight">My Orders</h1>
      <p class="mt-1 text-sm text-black/60">Track and manage all your orders</p>
    </div>

    <div class="mb-6 animate-fade-in">
      <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between">
        
        <div class="w-full md:flex-1 md:max-w-md">
          <form id="search-form" class="relative">
            <input type="text" 
                   id="search-input"
                   name="search"
                   placeholder="Search by Order ID..."
                   value=""
                   class="w-full pl-10 pr-4 py-2 sm:py-3 border border-black/20 rounded-lg focus:outline-none focus:border-black/40 bg-ash/30 text-sm">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="h-4 w-4 sm:h-5 sm:w-5 text-black/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
          </form>
          
          <div id="search-results" class="hidden absolute z-10 w-full md:max-w-md mt-1 bg-white border border-black/20 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
        </div>

        <div class="flex flex-1 md:flex-none gap-3 w-full sm:w-auto">
          <select id="status-filter" 
                  class="flex-1 px-3 py-2 sm:px-4 sm:py-3 border border-black/20 rounded-lg focus:outline-none focus:border-black/40 bg-white text-sm">
            <option value="all">All Status</option>
            <option value="Pending">Pending</option>
            <option value="Confirmed">Confirmed</option>
            <option value="Processing">Processing</option>
            <option value="Shipped">Shipped</option>
            <option value="Delivered">Delivered</option>
            <option value="Cancelled">Cancelled</option>
            <option value="Payment Failed">Payment Failed</option>
          </select>

          <select id="payment-filter" 
                  class="flex-1 px-3 py-2 sm:px-4 sm:py-3 border border-black/20 rounded-lg focus:outline-none focus:border-black/40 bg-white text-sm">
            <option value="all">All Payments</option>
            <option value="COD">COD</option>
            <option value="RAZORPAY">Online</option>
            <option value="WALLET">Wallet</option>
          </select>
        </div>
      </div>
    </div>

    <div class="animate-fade-in">
      <div id="orders-container" class="space-y-4">
        <div class="text-center py-12">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-black mx-auto mb-4"></div>
          <p class="text-black/60">Loading your orders...</p>
        </div>
      </div>

      <div id="pagination-container" class="mt-8 flex flex-col sm:flex-row items-center justify-between gap-4">
        </div>
    </div>
  </main>

  <div id="cancel-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex min-h-screen items-center justify-center p-4 bg-black/20 backdrop-blur-sm">
      <div class="bg-white rounded-xl shadow-2xl max-w-xs sm:max-w-md w-full">
        <div class="p-4 sm:p-6">
          <h3 class="text-lg font-semibold mb-4">Cancel Order</h3>
          <p class="text-sm text-black/70 mb-4">Are you sure you want to cancel this order? This action cannot be undone.</p>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Reason (Optional)</label>
            <textarea id="cancel-reason" 
                      placeholder="Please provide a reason for cancellation..."
                      rows="3"
                      class="w-full p-3 border border-black/20 rounded-lg focus:outline-none focus:border-black/40 resize-none text-sm"></textarea>
          </div>

          <div class="flex gap-3">
            <button id="cancel-modal-close"
                    class="flex-1 py-2 sm:py-3 border border-black/20 rounded-lg hover:bg-black/5 transition text-sm">
              Keep Order
            </button>
            <button id="confirm-cancel"
                    class="flex-1 py-2 sm:py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm">
              Cancel Order
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="return-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex min-h-screen items-center justify-center p-4 bg-black/20 backdrop-blur-sm">
      <div class="bg-white rounded-xl shadow-2xl max-w-xs sm:max-w-md w-full">
        <div class="p-4 sm:p-6">
          <h3 class="text-lg font-semibold mb-4">Request Return</h3>
          <p class="text-sm text-black/70 mb-4">Please provide a reason for the return request. Our team will review and process your request.</p>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Return Reason *</label>
            <textarea id="return-reason" 
                      placeholder="Please describe why you want to return this order (minimum 10 characters)..."
                      rows="4"
                      class="w-full p-3 border border-black/20 rounded-lg focus:outline-none focus:border-black/40 resize-none text-sm"
                      required></textarea>
            <div class="text-xs text-red-600 hidden" id="return-reason-error">Return reason is required (minimum 10 characters)</div>
          </div>

          <div class="flex gap-3">
            <button id="return-modal-close"
                    class="flex-1 py-2 sm:py-3 border border-black/20 rounded-lg hover:bg-black/5 transition text-sm">
              Cancel
            </button>
            <button id="confirm-return"
                    class="flex-1 py-2 sm:py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition text-sm">
              Submit Request
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    class OrderManager {
      constructor() {
        this.loadingOverlay = document.getElementById('loading-overlay');
        this.cancelModal = document.getElementById('cancel-modal');
        this.returnModal = document.getElementById('return-modal');
        this.currentOrderId = null;
        this.currentAction = null;
        this.currentPage = 1;
        this.currentFilters = {
          search: '',
          status: 'all',
          paymentMethod: 'all'
        };
        
        // Get user data from hidden div
        this.userData = this.getUserDataFromDiv();
        
        this.init();
      }

      getUserDataFromDiv() {
        try {
          const dataContainer = document.getElementById('user-data-container');
          if (!dataContainer) {
            return { id: '', name: 'Customer', email: 'customer@example.com' };
          }
          
          const jsonString = decodeURIComponent(dataContainer.dataset.user);
          return JSON.parse(jsonString);
        } catch (error) {
          console.error('Failed to parse user data:', error);
          return { id: '', name: 'Customer', email: 'customer@example.com' };
        }
      }

      init() {
        this.bindEvents();
        this.loadOrders();
      }

      bindEvents() {
        // Search functionality
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        let searchTimeout;

        searchInput.addEventListener('input', (e) => {
          clearTimeout(searchTimeout);
          const query = e.target.value.trim();
          
          if (query.length < 2) {
            searchResults.classList.add('hidden');
            return;
          }

          searchTimeout = setTimeout(() => {
            this.performSearch(query);
          }, 300);
        });

        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
          if (!e.target.closest('#search-form')) {
            searchResults.classList.add('hidden');
          }
        });

        // Filter change handlers
        document.getElementById('status-filter').addEventListener('change', (e) => {
          this.currentFilters.status = e.target.value;
          this.currentPage = 1;
          this.loadOrders();
        });

        document.getElementById('payment-filter').addEventListener('change', (e) => {
          this.currentFilters.paymentMethod = e.target.value;
          this.currentPage = 1;
          this.loadOrders();
        });

        // Search form submission
        document.getElementById('search-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.currentFilters.search = searchInput.value.trim();
          this.currentPage = 1;
          this.loadOrders();
        });

        // Modal controls
        document.getElementById('cancel-modal-close').addEventListener('click', () => this.closeCancelModal());
        document.getElementById('return-modal-close').addEventListener('click', () => this.closeReturnModal());
        document.getElementById('confirm-cancel').addEventListener('click', () => this.confirmCancel());
        document.getElementById('confirm-return').addEventListener('click', () => this.confirmReturn());

        // Close modals on outside click
        this.cancelModal.addEventListener('click', (e) => {
          if (e.target === this.cancelModal) this.closeCancelModal();
        });
        this.returnModal.addEventListener('click', (e) => {
          if (e.target === this.returnModal) this.closeReturnModal();
        });
      }

      async performSearch(query) {
        try {
          const response = await fetch(`/user/api/orders/search?q=${encodeURIComponent(query)}`, {
            credentials: 'include'
          });
          const result = await response.json();
          
          if (result.success) {
            this.displaySearchResults(result.data);
          }
        } catch (error) {
          console.error('Search error:', error);
        }
      }

      displaySearchResults(orders) {
        const container = document.getElementById('search-results');
        
        if (orders.length === 0) {
          container.innerHTML = '<div class="p-3 text-black/60 text-sm">No orders found</div>';
        } else {
          container.innerHTML = orders.map(order => `
            <a href="/user/orders/${order.referenceNo}" 
               class="block p-3 hover:bg-ash/30 transition border-b border-black/5 last:border-b-0">
              <div class="font-medium text-sm">#${order.referenceNo}</div>
              <div class="text-xs text-black/60">
                ${new Date(order.orderDate).toLocaleDateString('en-IN')} • 
                ${order.status} • 
                ₹${order.total.toLocaleString('en-IN')}
              </div>
            </a>
          `).join('');
        }
        
        container.classList.remove('hidden');
      }

      async loadOrders() {
        try {
          this.showLoading();
          
          const params = new URLSearchParams({
            page: this.currentPage,
            limit: 10,
            ...this.currentFilters
          });

          const response = await fetch(`/user/api/orders?${params}`, {
            credentials: 'include'
          });
          
          const result = await response.json();
          
          if (result.success) {
            this.renderOrders(result.data.orders);
            this.renderPagination(result.data.pagination);
          } else {
            this.showToast('error', result.error || 'Failed to load orders');
          }
          
        } catch (error) {
          console.error('Load orders error:', error);
          this.showToast('error', 'Failed to load orders');
        } finally {
          this.hideLoading();
        }
      }

      renderOrders(orders) {
        const container = document.getElementById('orders-container');
        
        if (orders.length === 0) {
          container.innerHTML = `
            <div class="text-center py-12 bg-ash/40 rounded-xl border border-black/10">
              <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-black/5">
                <svg class="h-8 w-8 text-black/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-black mb-2">No orders found</h3>
              <p class="text-black/60 mb-6">You haven't placed any orders yet</p>
              <a href="/user/product/list" class="inline-flex items-center px-6 py-3 bg-black text-white rounded-lg font-medium hover:bg-black/90 transition">
                Start Shopping
              </a>
            </div>
          `;
          return;
        }

        container.innerHTML = orders.map(order => `
          <div class="bg-ash/40 rounded-xl border border-black/10 p-4 sm:p-6 hover:border-black/20 transition ${order.status === 'Payment Failed' ? 'failed-payment-border' : ''}">
            ${order.status === 'Payment Failed' ? `
              <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                <div class="flex items-center gap-2 text-sm">
                  <i class="fas fa-exclamation-triangle text-red-600"></i>
                  <span class="text-red-800 font-medium">Payment Failed</span>
                  <span class="text-red-600 text-xs hidden sm:inline">• Payment can be retried anytime</span>
                </div>
                <p class="text-red-700 text-xs mt-1 sm:hidden">Payment can be retried anytime</p>
              </div>
            ` : ''}
            
            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
              
              <div class="flex-1">
                <div class="flex flex-wrap items-center gap-2 sm:gap-3 mb-3">
                  <h3 class="font-semibold text-base sm:text-lg">Order #${order.referenceNo}</h3>
                  <span class="inline-flex px-2 py-0.5 text-xs font-semibold rounded-full ${this.getStatusClass(order.status)}">
                    ${order.status}
                  </span>
                  ${order.paymentMethod === 'COD' ? '<span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">COD</span>' : ''}
                  ${order.paymentMethod === 'RAZORPAY' && order.status !== 'Payment Failed' ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">PAID</span>' : ''}
                  ${order.paymentMethod === 'RAZORPAY' && order.status === 'Payment Failed' ? '<span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full">UNPAID</span>' : ''}
                  ${order.paymentMethod === 'WALLET' ? '<span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">WALLET</span>' : ''}
                  ${order.coupon ? `<span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full hidden sm:inline">COUPON: ${order.coupon.code}</span>` : ''}
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-xs sm:text-sm text-black/70">
                  <div>
                    <span class="block font-medium text-black">Order Date</span>
                    ${new Date(order.orderDate).toLocaleDateString('en-IN')}
                  </div>
                  <div>
                    <span class="block font-medium text-black">Items</span>
                    ${order.itemCount} item${order.itemCount !== 1 ? 's' : ''}
                  </div>
                  <div class="hidden md:block">
                    <span class="block font-medium text-black">Payment</span>
                    ${this.getPaymentMethodDisplay(order.paymentMethod)}
                  </div>
                  <div>
                    <span class="block font-medium text-black">Total</span>
                    <div class="flex flex-col">
                      ${order.discount > 0 ? `<span class="text-xs text-green-600 line-through">₹${(order.total + order.discount).toLocaleString('en-IN')}</span>` : ''}
                      <span class="text-lg font-bold text-black">₹${order.total.toLocaleString('en-IN')}</span>
                      ${order.discount > 0 ? `<span class="text-xs text-green-600">Saved ₹${order.discount.toLocaleString('en-IN')}</span>` : ''}
                    </div>
                  </div>
                </div>

                ${order.coupon ? `
                  <div class="mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded-lg block md:hidden">
                    <div class="flex items-center gap-2 text-xs">
                      <i class="fas fa-ticket-alt text-yellow-600"></i>
                      <span class="font-medium text-yellow-800">Coupon:</span>
                      <span class="text-yellow-700">${order.coupon.code}</span>
                      <span class="text-yellow-600">(-₹${order.coupon.discountAmount.toLocaleString('en-IN')})</span>
                    </div>
                  </div>
                ` : ''}
              </div>

              <div class="flex flex-wrap gap-2 lg:flex-col lg:items-end">
                <a href="/user/orders/${order.referenceNo}" 
                   class="px-3 py-1.5 border border-black/20 text-black rounded-lg font-medium hover:bg-black/5 transition text-xs sm:text-sm">
                  View Details
                </a>

                ${order.status !== 'Payment Failed' ? `
                  <button onclick="downloadInvoice('${order.id}')"
                          class="px-3 py-1.5 bg-black text-white rounded-lg font-medium hover:bg-black/90 transition text-xs sm:text-sm">
                    <i class="fas fa-download mr-1"></i>
                    Invoice
                  </button>
                ` : ''}

                ${order.canRetryPayment ? `
                  <button onclick="retryPayment('${order.id}')"
                          class="retry-payment-btn px-3 py-1.5 text-white rounded-lg font-medium text-xs sm:text-sm flex items-center gap-1">
                    <i class="fas fa-redo-alt"></i>
                    Retry Payment
                  </button>
                ` : ''}

                ${order.canCancel ? `
                  <button onclick="showCancelModal('${order.id}', 'order')"
                          class="px-3 py-1.5 border border-red-300 text-red-700 rounded-lg font-medium hover:bg-red-50 transition text-xs sm:text-sm">
                    Cancel Order
                  </button>
                ` : ''}

                ${order.canReturn ? `
                  <button onclick="showReturnModal('${order.id}')"
                          class="px-3 py-1.5 border border-orange-300 text-orange-700 rounded-lg font-medium hover:bg-orange-50 transition text-xs sm:text-sm">
                    Return Order
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `).join('');
      }

      renderPagination(pagination) {
        const container = document.getElementById('pagination-container');
        if (!container) return;

        if (pagination.totalPages <= 1) {
          container.style.display = 'none';
          return;
        }

        container.style.display = 'flex';
        container.innerHTML = `
          <div class="text-xs sm:text-sm text-black/60">
            Showing orders ${pagination.startIndex}-${pagination.endIndex} of ${pagination.totalOrders}
          </div>
          
          <div class="flex gap-1 sm:gap-2">
            ${pagination.hasPrev ? `
              <button onclick="orderManager.changePage(${pagination.currentPage - 1})"
                      class="px-3 py-1.5 sm:px-4 sm:py-2 border border-black/20 text-black rounded-lg hover:bg-black/5 transition text-xs sm:text-sm">
                Previous
              </button>
            ` : ''}
            
            ${Array.from({length: Math.min(5, pagination.totalPages)}, (_, i) => {
              const page = Math.max(1, pagination.currentPage - 2) + i;
              if (page > pagination.totalPages) return '';
              return `
                <button onclick="orderManager.changePage(${page})"
                        class="px-3 py-1.5 sm:px-4 sm:py-2 ${page === pagination.currentPage ? 'bg-black text-white' : 'border border-black/20 text-black hover:bg-black/5'} rounded-lg transition text-xs sm:text-sm">
                  ${page}
                </button>
              `;
            }).join('')}
            
            ${pagination.hasNext ? `
              <button onclick="orderManager.changePage(${pagination.currentPage + 1})"
                      class="px-3 py-1.5 sm:px-4 sm:py-2 border border-black/20 text-black rounded-lg hover:bg-black/5 transition text-xs sm:text-sm">
                Next
              </button>
            ` : ''}
          </div>
        `;
      }

      changePage(page) {
        this.currentPage = page;
        this.loadOrders();
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      getStatusClass(status) {
        switch(status) {
          case 'Delivered': return 'bg-green-100 text-green-800';
          case 'Shipped': return 'bg-blue-100 text-blue-800';
          case 'Cancelled': return 'bg-red-100 text-red-800';
          case 'Payment Failed': return 'bg-red-100 text-red-800 animate-pulse-red';
          case 'Processing': return 'bg-yellow-100 text-yellow-800';
          case 'Confirmed': return 'bg-indigo-100 text-indigo-800';
          default: return 'bg-gray-100 text-gray-800';
        }
      }

      getPaymentMethodDisplay(method) {
        switch(method) {
          case 'COD': return 'Cash on Delivery';
          case 'RAZORPAY': return 'Online Payment';
          case 'WALLET': return 'Wallet Payment';
          default: return method;
        }
      }

      // Retry Payment Functionality (No Time Limit)
      async retryPayment(orderId) {
        try {
          this.showLoading();
          
          const response = await fetch(`/user/api/order/retry-payment/${orderId}`, {
            method: 'POST',
            credentials: 'include'
          });
          
          const result = await response.json();
          
          if (result.success) {
            this.hideLoading();
            this.initiateRazorpayRetryPayment(result.data, orderId);
          } else {
            this.showToast('error', result.error || 'Unable to retry payment at this time');
          }
          
        } catch (error) {
          console.error('Retry payment error:', error);
          this.showToast('error', 'Failed to initiate payment retry');
        } finally {
          this.hideLoading();
        }
      }

      initiateRazorpayRetryPayment(paymentData, orderId) {
        const options = {
          key: paymentData.razorpayKeyId,
          amount: paymentData.amount,
          currency: 'INR',
          name: 'Superkicks',
          description: 'Retry Order Payment',
          order_id: paymentData.razorpayOrderId,
          retry: { enabled: false },
          handler: async (response) => {
            await this.verifyRetryPayment({
              orderId: orderId,
              razorpay_payment_id: response.razorpay_payment_id,
              razorpay_order_id: response.razorpay_order_id,
              razorpay_signature: response.razorpay_signature
            });
          },
          prefill: {
            name: this.userData.name,
            email: this.userData.email,
            contact: this.userData.phone || '9999999999'
          },
          theme: { color: '#000000' },
          modal: {
            ondismiss: () => {
              this.showToast('info', 'Payment cancelled. You can retry anytime from your orders.');
            }
          }
        };

        const rzp = new Razorpay(options);
        
        rzp.on('payment.failed', (response) => {
          console.log('Payment failed:', response);
          this.showToast('error', 'Payment failed. Please try again or contact support.');
        });

        rzp.open();
      }

      async verifyRetryPayment(paymentData) {
        try {
          this.showLoading();
          
          const response = await fetch('/user/api/order/verify-retry-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(paymentData)
          });
          
          const result = await response.json();
          
          if (result.success) {
            this.showToast('success', 'Payment successful! Your order has been confirmed.');
            setTimeout(() => {
              window.location.href = `/user/order-success/${result.data.orderId}`;
            }, 2000);
          } else {
            this.showToast('error', 'Payment verification failed. Please contact support.');
          }
          
        } catch (error) {
          console.error('Verify retry payment error:', error);
          this.showToast('error', 'Payment verification failed');
        } finally {
          this.hideLoading();
        }
      }

      showLoading() {
        this.loadingOverlay.classList.remove('hidden');
      }

      hideLoading() {
        this.loadingOverlay.classList.add('hidden');
      }

      showCancelModal(orderId, type = 'order') {
        this.currentOrderId = orderId;
        this.currentAction = type;
        this.cancelModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }

      closeCancelModal() {
        this.cancelModal.classList.add('hidden');
        document.body.style.overflow = '';
        document.getElementById('cancel-reason').value = '';
        this.currentOrderId = null;
        this.currentAction = null;
      }

      showReturnModal(orderId) {
        this.currentOrderId = orderId;
        this.returnModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }

      closeReturnModal() {
        this.returnModal.classList.add('hidden');
        document.body.style.overflow = '';
        document.getElementById('return-reason').value = '';
        document.getElementById('return-reason-error').classList.add('hidden');
        this.currentOrderId = null;
      }

      async confirmCancel() {
        try {
          this.showLoading();
          
          const reason = document.getElementById('cancel-reason').value.trim();
          
          const response = await fetch(`/user/api/orders/${this.currentOrderId}/cancel`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ reason })
          });
          
          const result = await response.json();
          
          if (result.success) {
            this.showToast('success', result.message);
            this.closeCancelModal();
            this.loadOrders();
          } else {
            this.showToast('error', result.error);
          }
          
        } catch (error) {
          console.error('Cancel error:', error);
          this.showToast('error', 'Failed to cancel order');
        } finally {
          this.hideLoading();
        }
      }

      async confirmReturn() {
        const reasonInput = document.getElementById('return-reason');
        const errorElement = document.getElementById('return-reason-error');
        const reason = reasonInput.value.trim();
        
        if (reason.length < 10) {
          errorElement.classList.remove('hidden');
          reasonInput.focus();
          return;
        }
        
        errorElement.classList.add('hidden');
        
        try {
          this.showLoading();
          
          const response = await fetch(`/user/api/orders/${this.currentOrderId}/returns`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ reason })
          });
          
          const result = await response.json();
          
          if (result.success) {
            this.showToast('success', result.message);
            this.closeReturnModal();
            this.loadOrders(); 
          } else {
            this.showToast('error', result.error);
          }
          
        } catch (error) {
          console.error('Return error:', error);
          this.showToast('error', 'Failed to submit return request');
        } finally {
          this.hideLoading();
        }
      }

      showToast(type, message) {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full opacity-0`;
        
        if (type === 'success') {
          toast.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-200');
        } else if (type === 'info') {
          toast.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-200');
        } else {
          toast.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-200');
        }
        
        toast.innerHTML = `
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'info' ? 'info-circle' : 'exclamation-circle'} mr-2"></i>
          <span>${message}</span>
        `;

        document.body.appendChild(toast);

        setTimeout(() => {
          toast.classList.remove('translate-x-full', 'opacity-0');
          toast.classList.add('translate-x-0', 'opacity-100');
        }, 100);
        
        setTimeout(() => {
          toast.classList.add('translate-x-full', 'opacity-0');
          setTimeout(() => toast.remove(), 300);
        }, 4000);
      }
    }

    // Global functions
    function showCancelModal(orderId, type = 'order') {
      orderManager.showCancelModal(orderId, type);
    }

    function showReturnModal(orderId) {
      orderManager.showReturnModal(orderId);
    }

    function retryPayment(orderId) {
      orderManager.retryPayment(orderId);
    }

    async function downloadInvoice(orderId) {
      try {
        orderManager.showLoading();
        
        const response = await fetch(`/user/orders/${orderId}/invoice`, {
          method: 'GET',
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Failed to generate invoice');
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `invoice-${orderId}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        orderManager.showToast('success', 'Invoice downloaded successfully!');
        
      } catch (error) {
        console.error('Download error:', error);
        orderManager.showToast('error', 'Failed to download invoice');
      } finally {
        orderManager.hideLoading();
      }
    }

    // Initialize order manager
    const orderManager = new OrderManager();
  </script>
</body>
</html>